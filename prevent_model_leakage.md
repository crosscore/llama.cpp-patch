## 前提条件

- Android StudioでKotlinを使用し、推論の高速化のためにllama.cppを利用する。
- llama.cppはb2710ブランチのデータを使用しており、最新ブランチではない。
- 推論に使用するモデルは、8bit量子化された5GB以上のGGUFファイルである。
- GGUFをapkに組み込むことはサイズ制限により不可能であるため、アプリ実行中に外部サーバー(S3など)からAndroidスマートフォンにダウンロードする方式を採用する。
- 悪意のある第三者がこのアプリをAndroidにインストールしてモデルをダウンロードした後、モデルデータを奪われないようにするための対策が必要である。
- **コード難読化はDashOを使用し、他の手法は採用しないものとする。**
- 前提条件の性質上、モデルの流出を100%防ぐことは不可能であるため、最善の対策を検討する。

---

以下の対策を優先度の高い順に番号を付け、各対策のメリットとデメリットをまとめます。

### **1. モデルデータの暗号化**

**対策内容:**

- モデルデータをAES-256などの強力な暗号化アルゴリズムで暗号化し、S3にアップロードする前に保護します。
- アプリ内でモデルを使用する際に復号化を行い、メモリ上でのみ復号化されたデータを扱います。

**メリット:**

- 暗号化されたモデルデータは、鍵がなければ利用できないため、流出しても安全性が保たれます。
- データの保管および転送中のセキュリティが強化されます。

**デメリット:**

- 復号化処理により、モデルのロード時間が若干増加する可能性があります。
- 復号化されたモデルがメモリ上に存在する間、メモリダンプ攻撃のリスクがあります。

---

### **2. 暗号鍵の安全な管理（Android Keystoreの利用）**

**対策内容:**

- 暗号化・復号化に使用する鍵をAndroidのKeystoreシステムで安全に管理します。
- 鍵はデバイス内に安全に保存され、アプリ外からのアクセスや抽出が困難になります。

**メリット:**

- 鍵の安全性が高まり、鍵の漏洩リスクが低減します。
- システムレベルでの保護により、セキュリティが強化されます。

**デメリット:**

- デバイスがRoot化されている場合、鍵が抽出されるリスクがあります。
- 実装が複雑になる可能性があり、適切な管理が必要です。

---

### **3. ランタイム時の安全な鍵配信**

**対策内容:**

- アプリ起動時またはモデル使用時に、セキュアなサーバーから暗号化鍵を取得します。
- 鍵はデバイス上に保存せず、一時的にメモリ上でのみ使用します。

**メリット:**

- 鍵がデバイスに恒久的に存在しないため、鍵の漏洩リスクがさらに低減します。
- 暗号化されたモデルデータだけでは利用できないため、セキュリティが向上します。

**デメリット:**

- 鍵取得のためにネットワーク接続が必要となり、オフライン環境での利用が制限されます。
- 鍵配信サーバーのセキュリティと可用性を維持する必要があります。

---

### **4. 認証と安全な通信の実装（証明書ピンニング）**

**対策内容:**

- アプリとサーバー間の通信において、HTTPSを使用し、証明書ピンニングを実装します。
- デバイスやユーザーの認証を行い、正規のアプリからのリクエストのみを許可します。

**メリット:**

- 通信経路での中間者攻撃を防止し、データの盗聴や改ざんを防ぎます。
- 不正なデバイスやユーザーからのアクセスを制限できます。

**デメリット:**

- 証明書の管理が必要であり、証明書の更新時にはアプリのアップデートが必要になる場合があります。
- 実装が複雑であり、専門的な知識が求められます。

---

### **5. ライセンスキーの導入と使用制限の実装**

**対策内容:**

- アプリ起動時またはモデル使用時に、サーバーからライセンスキーやトークンを取得し、正規ユーザーのみがモデルを使用できるようにします。
- ライセンスキーに有効期限や使用回数の制限を設け、不正な利用を防止します。

**メリット:**

- モデルの不正使用や不正コピーを防ぎ、使用状況を管理できます。
- ライセンスキーを無効化することで、不正なアクセスを迅速に遮断できます。

**デメリット:**

- ライセンスキー取得のためにネットワーク接続が必要となります。
- ライセンス管理システムの運用とセキュリティ対策が必要です。

---

### **6. モデルのウォーターマーキングの実装**

**対策内容:**

- モデルの重みや構造に識別可能なウォーターマークを埋め込みます。
- 流出したモデルや出力結果を解析することで、ウォーターマークを検出し、不正使用を特定します。

**メリット:**

- モデルが流出した場合に、追跡や法的措置のための証拠を収集できます。
- 不正な再配布に対する抑止力となります。

**デメリット:**

- ウォーターマークの実装により、モデルの性能や精度に影響を与える可能性があります。
- 高度な攻撃者によってウォーターマークが除去されるリスクがあります。

---

### **7. ルート化検出の実装**

**対策内容:**

- デバイスがRoot化されているかを検出し、Root化されたデバイスでのアプリの動作を制限または停止します。

**メリット:**

- Root化デバイスでのセキュリティリスクを低減し、鍵の抽出やメモリダンプ攻撃を防止します。
- アプリのセキュリティポリシーを強化できます。

**デメリット:**

- 一部の正規ユーザーがRoot化デバイスを使用している場合、ユーザー体験を損なう可能性があります。
- Root検出は回避される可能性があり、完全な防御策ではありません。

---

### **8. 法的対策と利用規約の強化**

**対策内容:**

- アプリの利用規約にモデルの取り扱いに関する明確な規定を設け、不正使用時の法的措置を明記します。
- モデルの著作権や利用制限に関する情報をユーザーに周知します。

**メリット:**

- 法的な抑止力を持たせることで、不正行為の発生を減少させます。
- 万が一の流出時に、法的手段を講じるための基盤を確立できます。

**デメリット:**

- 法的措置には時間とコストがかかり、国際的な対応が難しい場合があります。
- 法的対策だけでは技術的な流出防止には直接的な効果がありません。

---

### **9. ホワイトボックス暗号技術の適用**

**対策内容:**

- 暗号鍵をアルゴリズム内部に埋め込み、リバースエンジニアリングを行っても鍵が抽出されにくいホワイトボックス暗号を実装します。
- モデルの復号化と推論処理を一体化し、鍵とモデルを保護します。

**メリット:**

- 鍵の安全性が大幅に向上し、攻撃者が鍵を取得することが非常に困難になります。
- セキュリティレベルが高く、機密性の高いアプリケーションに適しています。

**デメリット:**

- 実装が非常に複雑で、高度な専門知識が必要です。
- パフォーマンスへの影響が大きく、モバイル環境では実用的でない場合があります。

---

**注記:**

- 上記の対策は、単独でも効果がありますが、複数を組み合わせることでセキュリティをさらに強化できます。

- 前提条件から、モデルの流出を完全に防ぐことは困難であるため、技術的対策と法的対策をバランスよく組み合わせ、現実的なセキュリティレベルを維持することが求められます。
