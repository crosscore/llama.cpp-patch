## 前提条件

- **開発環境と技術スタック：**
  - Android StudioでKotlinを使用
  - 推論の高速化のためにllama.cpp（b2710ブランチ）を利用

- **モデルの特性：**
  - 8bit量子化された5GB以上のGGUFファイル
  - GGUFをapkに組み込むことはサイズ制限により不可能

- **モデルの配布方法：**
  - アプリ実行中にS3などの外部サーバーからAndroidデバイスにダウンロードする

- **セキュリティ要件：**
  - 悪意のある第三者がモデルデータを取得・流出させないための対策が必要
  - モデルの流出を100%防ぐことは不可能であるため、最善の対策を講じる

- **コード難読化：**
  - **DashOを使用してコード難読化を行う。他の難読化手法は使用しない**

---

## 採用する対策

### **1. モデルデータの暗号化（チャンク単位での復号化を含む）**

**対策内容:**

- **モデルの暗号化：**
  - モデルデータをAES-256などの強力な暗号化アルゴリズムで暗号化し、サーバーに保存する
- **チャンク単位での復号化：**
  - モデルデータを読み込む際に、ストリームを使用してチャンクごとに復号化する
  - 一度に全てのデータをメモリに読み込む必要がなくなる

**メリット:**

- 暗号化されたモデルデータは、鍵がなければ利用できないため、流出しても安全性が保たれる
- チャンク単位での復号化により、メモリ使用量を抑えつつ大容量のモデルを扱える
- 実装が比較的容易であり、既存の暗号化ライブラリやストリーム処理を活用できる

**デメリット:**

- 復号化処理により、モデル読み込み時のパフォーマンスが若干低下する可能性がある
- デバイスのI/O性能によっては、読み込み速度がボトルネックになる場合がある

---

### **2. 暗号鍵の安全な管理（Android Keystoreの利用）**

**対策内容:**

- **Android Keystoreの利用：**
  - 暗号化・復号化に使用する鍵をAndroid Keystoreシステムで安全に管理する
  - 鍵はデバイス内に安全に保存され、アプリ外からのアクセスや抽出が困難になる

**メリット:**

- 鍵の安全性が高まり、鍵の漏洩リスクが低減する
- システムレベルでの保護により、セキュリティが強化される

**デメリット:**

- デバイスがRoot化されている場合、鍵が抽出されるリスクがある
- 一部の古いデバイスやOSバージョンでは、Keystoreの機能が制限される可能性がある

---

### **3. 認証と安全な通信の実装（証明書ピンニング）**

**対策内容:**

- **安全な通信の確立：**
  - アプリとサーバー間の通信において、HTTPSを使用し、証明書ピンニングを実装する
  - 中間者攻撃を防止し、通信データの盗聴や改ざんを防ぐ

**メリット:**

- 通信経路でのセキュリティが強化され、データの安全な送受信が可能になる
- 不正なデバイスやユーザーからのアクセスを制限できる

**デメリット:**

- 証明書の管理が必要であり、証明書の更新時にはアプリのアップデートが必要になる場合がある
- 実装が複雑であり、専門的な知識が求められる

---

## 実装時のポイント

### **モデルデータの暗号化**

- **手順:**
  - **サーバー側での暗号化：**
    - モデルデータをAES-256などの強力な暗号化アルゴリズムで暗号化し、サーバーに保存する
  - **アプリ側での復号化：**
    - モデルデータをダウンロードする際、ストリームを用いてデータを読み込みつつ、チャンク単位で復号化する
    - 復号化したデータをそのままファイルとして保存し、llama.cppで読み込めるようにする

- **注意点:**
  - ストリーム処理に対応した暗号化ライブラリを使用することで、実装の複雑さを抑えられる
  - llama.cpp自体の改修は不要であり、ファイルの読み込み部分で復号化処理を挟む形で実装可能

### **暗号鍵の安全な管理（Android Keystoreの利用）**

- **手順:**
  - 暗号鍵をAndroid Keystoreに安全に保存し、復号化時にのみ鍵を使用する

- **注意点:**
  - 鍵がデバイス外部に漏洩しないよう、適切なAPIを使用して管理する

### **認証と安全な通信の実装（証明書ピンニング）**

- **手順:**
  - アプリとサーバー間の通信にHTTPSを使用し、証明書ピンニングを実装する

- **注意点:**
  - サーバー証明書の更新時にはアプリのアップデートが必要となる場合があるため、証明書の有効期限に注意する

---

## まとめ

- **モデルデータの暗号化（チャンク単位での復号化）**により、大容量モデルでもメモリ効率よくセキュアに扱える
- **暗号鍵の安全な管理（Android Keystoreの利用）**により、鍵の漏洩リスクを低減し、セキュリティを強化できる
- **認証と安全な通信の実装（証明書ピンニング）**により、通信経路でのデータ盗聴や改ざんを防止できる

これらの対策は、比較的少ない労力で実装可能であり、モデル流出防止とセキュリティ強化に直接的な効果があります。労力と効果のバランスを考慮し、最も実用的で効果的な対策を優先的に実施します。

---
